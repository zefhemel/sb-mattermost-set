{
  "name": "set",
  "assets": {
    "templates/next-week-template.txt": "data:text/plain;base64,IyMjIEhlYWTigJlzIHVwOiBTRVQgb24gY2FsbCBmb3IgbmV4dCB3ZWVrCkhlbGxvLCBoZXJlIGlzIHRoZSBTRVQgb24tY2FsbCBmb3IgdGhlIHdlZWsgb2Yge3tkYXRlfX0uIFtHZXQgeW91ciBwYWdlcnMgb25dKGh0dHBzOi8vaGFuZGJvb2subWF0dGVybW9zdC5jb20vb3BlcmF0aW9ucy9yZXNlYXJjaC1hbmQtZGV2ZWxvcG1lbnQvZW5naW5lZXJpbmcvdGVhbSkhCgoqKlNFVCBMZWFkOioqIEB7e2xlYWQudXNlcm5hbWV9fQoqKlByaW1hcmllczoqKiB7eyNlYWNoIHByaW1hcnl9fUB7e3VzZXJuYW1lfX0ge3svZWFjaH19CioqQmFja3VwczoqKiB7eyNlYWNoIGJhY2t1cH19QHt7dXNlcm5hbWV9fSB7ey9lYWNofX0K",
    "templates/message-template.txt": "data:text/plain;base64,IyMgU0VUIFNjaGVkdWxlIGZvciB0aGUgd2VlayBvZiB7e2RhdGV9fQoqKlNFVCBMZWFkOioqIEB7e2xlYWQudXNlcm5hbWV9fQoqKlByaW1hcmllczoqKiB7eyNlYWNoIHByaW1hcnl9fUB7e3VzZXJuYW1lfX0ge3svZWFjaH19CioqQmFja3VwczoqKiB7eyNlYWNoIGJhY2t1cH19QHt7dXNlcm5hbWV9fSB7ey9lYWNofX0KCldhbnQgdG8gbm90aWZ5IGV2ZXJ5Ym9keSBpbiBTRVQgYXQgb25jZT8gVXNlIHRoZSBAc2V0IGdyb3VwIG1lbnRpb24u",
    "templates/header.txt": "data:text/plain;base64,W0hvdyBpdCB3b3Jrc10oaHR0cHM6Ly9oYW5kYm9vay5tYXR0ZXJtb3N0LmNvbS9vcGVyYXRpb25zL3Jlc2VhcmNoLWFuZC1kZXZlbG9wbWVudC9lbmdpbmVlcmluZy90ZWFtKSB8IFtKSVJBXShodHRwczovL21hdHRlcm1vc3QuYXRsYXNzaWFuLm5ldC9zZWN1cmUvUmFwaWRCb2FyZC5qc3BhP3JhcGlkVmlldz0zMyZ2aWV3PWRldGFpbCkgfCBbT24tQ2FsbCBHdWlkZV0oaHR0cHM6Ly9oYW5kYm9vay5tYXR0ZXJtb3N0LmNvbS9vcGVyYXRpb25zL3Jlc2VhcmNoLWFuZC1kZXZlbG9wbWVudC9lbmdpbmVlcmluZy90ZWFtL29uLWNhbGwpIHwgW0FyZWFzIG9mIE93bmVyc2hpcF0oaHR0cHM6Ly9oYW5kYm9vay5tYXR0ZXJtb3N0LmNvbS9vcGVyYXRpb25zL3Jlc2VhcmNoLWFuZC1kZXZlbG9wbWVudC9vcmdhbml6YXRpb24pIHwgW1NFVCBjeWNsZSBQbGF5Ym9va10oaHR0cHM6Ly9jb21tdW5pdHkubWF0dGVybW9zdC5jb20vcGxheWJvb2tzL3BsYXlib29rcy93MzZybzc4Y2dqOHF0anE1bWY2c2F5N2J4ZSkgfCB7e2RhdGV9fSBSb3RhdGlvbjogTGVhZDogQHt7bGVhZC51c2VybmFtZX19IFByaW1hcmllczoge3sjZWFjaCBwcmltYXJ5fX1Ae3t1c2VybmFtZX19IHt7L2VhY2h9fSBCYWNrdXBzOiB7eyNlYWNoIGJhY2t1cH19QHt7dXNlcm5hbWV9fSB7ey9lYWNofX0gfCBTRVQgdG8gbW9uaXRvciB+c3VzdGFpbmVkLWVuZ2luZWVyaW5nIGFuZCB+YXNrLXItYW5kLWQ="
  },
  "imports": [
    "https://get.silverbullet.md/global.plug.json"
  ],
  "functions": {
    "postOnCallNextWeekCommand": {
      "command": {
        "name": "OpsGenie: Post Next Week Schedule"
      },
      "code": "(() => { var mod=(()=>{var y=Object.create;var i=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var b=Object.getPrototypeOf,v=Object.prototype.hasOwnProperty;var l=(e=>typeof require!=\"undefined\"?require:typeof Proxy!=\"undefined\"?new Proxy(e,{get:(t,r)=>(typeof require!=\"undefined\"?require:t)[r]}):e)(function(e){if(typeof require!=\"undefined\")return require.apply(this,arguments);throw new Error('Dynamic require of \"'+e+'\" is not supported')});var m=(e,t)=>{for(var r in t)i(e,r,{get:t[r],enumerable:!0})},d=(e,t,r,p)=>{if(t&&typeof t==\"object\"||typeof t==\"function\")for(let s of w(t))!v.call(e,s)&&s!==r&&i(e,s,{get:()=>t[s],enumerable:!(p=h(t,s))||p.enumerable});return e};var u=(e,t,r)=>(r=e!=null?y(b(e)):{},d(t||!e||!e.__esModule?i(r,\"default\",{value:e,enumerable:!0}):r,e)),T=e=>d(i({},\"__esModule\",{value:!0}),e);var B={};m(B,{default:()=>q});typeof self>\"u\"&&(self={syscall:()=>{throw new Error(\"Not implemented here\")}});var n=self.syscall;var a={};m(a,{invokeCommand:()=>D,invokeFunction:()=>k,listCommands:()=>E,reloadPlugs:()=>F});function k(e,t,...r){return n(\"system.invokeFunction\",e,t,...r)}function D(e){return n(\"system.invokeCommand\",e)}function E(){return n(\"system.listCommands\")}function F(){n(\"system.reloadPlugs\")}var o=self.syscall;var j=u(l(\"https://esm.sh/handlebars\"));var W=u(l(\"https://deno.land/std/encoding/yaml.ts\"));var x=u(l(\"https://deno.land/std/encoding/yaml.ts\"));function P(){return a.invokeFunction(\"server\",\"postOnCallNextWeek\")}var q=P;return T(B);})();\n return mod;})()"
    },
    "postOnCallNextWeek": {
      "env": "server",
      "cron": "0 8 * * 3",
      "code": "(() => { var mod=(()=>{var K=Object.create;var x=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var Q=Object.getPrototypeOf,H=Object.prototype.hasOwnProperty;var S=(e=>typeof require!=\"undefined\"?require:typeof Proxy!=\"undefined\"?new Proxy(e,{get:(t,r)=>(typeof require!=\"undefined\"?require:t)[r]}):e)(function(e){if(typeof require!=\"undefined\")return require.apply(this,arguments);throw new Error('Dynamic require of \"'+e+'\" is not supported')});var P=(e,t)=>{for(var r in t)x(e,r,{get:t[r],enumerable:!0})},N=(e,t,r,n)=>{if(t&&typeof t==\"object\"||typeof t==\"function\")for(let o of z(t))!H.call(e,o)&&o!==r&&x(e,o,{get:()=>t[o],enumerable:!(n=V(t,o))||n.enumerable});return e};var A=(e,t,r)=>(r=e!=null?K(Q(e)):{},N(t||!e||!e.__esModule?x(r,\"default\",{value:e,enumerable:!0}):r,e)),J=e=>N(x({},\"__esModule\",{value:!0}),e);var Ce={};P(Ce,{default:()=>Ae});typeof self>\"u\"&&(self={syscall:()=>{throw new Error(\"Not implemented here\")}});var s=self.syscall;var y={};P(y,{parseMarkdown:()=>te});function te(e){return s(\"markdown.parseMarkdown\",e)}var m={};P(m,{deleteAttachment:()=>de,deletePage:()=>ae,getAttachmentMeta:()=>ce,getPageMeta:()=>oe,listAttachments:()=>ue,listPages:()=>ne,listPlugs:()=>le,readAttachment:()=>pe,readPage:()=>se,writeAttachment:()=>me,writePage:()=>ie});function ne(e=!1){return s(\"space.listPages\",e)}function oe(e){return s(\"space.getPageMeta\",e)}function se(e){return s(\"space.readPage\",e)}function ie(e,t){return s(\"space.writePage\",e,t)}function ae(e){return s(\"space.deletePage\",e)}function le(){return s(\"space.listPlugs\")}function ue(){return s(\"space.listAttachments\")}function ce(e){return s(\"space.getAttachmentMeta\",e)}function pe(e){return s(\"space.readAttachment\",e)}function me(e,t,r){return s(\"space.writeAttachment\",e,t,r)}function de(e){return s(\"space.deleteAttachment\",e)}var h={};P(h,{readAsset:()=>fe});function L(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let o=0;o<r;o++)n[o]=t.charCodeAt(o);return n}var p=self.syscall;async function fe(e,t=\"utf8\"){let r=await p(\"asset.readAsset\",e);switch(t){case\"utf8\":return new TextDecoder().decode(L(r.split(\",\")[1]));case\"dataurl\":return r}}var q=A(S(\"https://esm.sh/handlebars\"));var R=A(S(\"https://deno.land/std/encoding/yaml.ts\"));function C(e,t){if(t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...C(n,t)];return r}function k(e,t){return C(e,r=>r.type===t)[0]}function I(e,t){C(e,t)}var D=A(S(\"https://deno.land/std/encoding/yaml.ts\"));async function w(e,t=[\"yaml\"]){let r=await m.readPage(e),n=await y.parseMarkdown(r),o={};return I(n,a=>{if(a.type!==\"FencedCode\")return!1;let i=k(a,\"CodeInfo\");if(!i||!t.includes(i.children[0].text))return!1;let l=k(a,\"CodeText\");if(!l)return!1;let f=l.children[0].text;try{o=D.parse(f)}catch(c){throw console.error(\"YAML Page parser error\",c),new Error(`YAML Error: ${c.message}`)}return!0}),o}async function b(e){try{let t=await w(\"SECRETS\",[\"yaml\",\"secrets\"]),r=[];for(let n of e){let o=t[n];if(o)r.push(o);else throw new Error(`No such secret: ${n}`)}return r}catch(t){throw t.message===\"Page not found\"?new Error(`No such secret: ${e[0]}`):t}}var Y=\"https://community.mattermost.com\",G=\"https://mattermost.app.opsgenie.com/webapi/webcal/getRecentSchedule\";var E=\"ak1ac7bhujgqzypnbijcq6m9tw\",F=\"opsgenie/user-mappings\";async function be(e,t){let r=R.stringify(t);await m.writePage(e,\"```yaml\\n\"+r+\"\\n```\")}var d;async function ve(){d||(d=await w(F))}async function Te(){await be(F,d)}async function W(e,t,r){let[n]=await b([\"setMattermostToken\"]),o=`${Y}${e}`,a={Authorization:`Bearer ${n}`,\"Content-Type\":\"application/json\"},i=await fetch(o,{method:t,headers:a,body:r?JSON.stringify(r):void 0});if(i.status<200&&i.status>=300)throw new Error(`${i.status} ${await i.text()}`);return await i.json()}async function v(e){if(await ve(),d[e])return d[e];let t=(await W(`/api/v4/users/autocomplete?name=${encodeURIComponent(e)}`,\"GET\")).users;if(t.length===0)throw new Error(`No matching user found: ${e}`);t.length>1&&console.warn(\"Multiple users found\",t.map(n=>n.username));let r={id:t[0].id,username:t[0].username};return d[e]=r,await Te(),r}function j(e){return W(\"/api/v4/posts\",\"POST\",{channel_id:E,message:e})}function Me(e){return new Date(`${e.substring(0,4)}-${e.substring(4,6)}-${e.substring(6,8)}`)}async function O(e){let[t]=await b([\"setOpsGenieTokens\"]),o=(await(await fetch(`${G}?${t[e]}`)).text()).split(`\n`),a,i,l=[];for(let u=0;u<o.length;u++){let g=o[u];if(g.startsWith(\"DTSTART;\"))a=Me(g.split(\":\")[1].split(\"T\")[0]);else if(g.startsWith(\"SUMMARY:\")){let _=g.substring(8).split(\"(\")[0].trim();l.push({name:_,date:a})}}let f=[],c=l[0].name,T=l[0].date,M=l[0].date;for(let u of l)u.name!==c&&(f.push({name:c,start:T,end:M}),T=u.date,c=u.name),M=u.date;return f.push({name:c,start:T,end:M}),f}async function Se(e=new Date){let[t,r,n]=await Promise.all([O(\"lead\"),O(\"primary\"),O(\"backup\")]),a={date:new Date(e.setDate(e.getDate()-e.getDay()+1)).toISOString().split(\"T\")[0],lead:await v(U(t,e)[0].name),primary:[],backup:[]};for(let{name:i}of U(r,e))a.primary.push(await v(i));for(let{name:i}of U(n,e))a.backup.push(await v(i));return a}async function B(){let e=await h.readAsset(\"templates/next-week-template.txt\");try{let t=new Date;t.setDate(t.getDate()+7);let r=q.default.compile(e,{noEscape:!0}),n=await Se(t),o=r(n);await j(o)}catch(t){throw console.error(\"Error\",t),t}}function U(e,t){let r=[];for(let n of e)n.start<=t&&t<=n.end&&r.push(n);return r}var Ae=B;return J(Ce);})();\n return mod;})()"
    },
    "postOnCallCommand": {
      "command": {
        "name": "OpsGenie: Post Current Schedule"
      },
      "code": "(() => { var mod=(()=>{var y=Object.create;var i=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var b=Object.getPrototypeOf,v=Object.prototype.hasOwnProperty;var l=(e=>typeof require!=\"undefined\"?require:typeof Proxy!=\"undefined\"?new Proxy(e,{get:(t,r)=>(typeof require!=\"undefined\"?require:t)[r]}):e)(function(e){if(typeof require!=\"undefined\")return require.apply(this,arguments);throw new Error('Dynamic require of \"'+e+'\" is not supported')});var m=(e,t)=>{for(var r in t)i(e,r,{get:t[r],enumerable:!0})},d=(e,t,r,p)=>{if(t&&typeof t==\"object\"||typeof t==\"function\")for(let s of w(t))!v.call(e,s)&&s!==r&&i(e,s,{get:()=>t[s],enumerable:!(p=h(t,s))||p.enumerable});return e};var u=(e,t,r)=>(r=e!=null?y(b(e)):{},d(t||!e||!e.__esModule?i(r,\"default\",{value:e,enumerable:!0}):r,e)),T=e=>d(i({},\"__esModule\",{value:!0}),e);var B={};m(B,{default:()=>W});typeof self>\"u\"&&(self={syscall:()=>{throw new Error(\"Not implemented here\")}});var n=self.syscall;var a={};m(a,{invokeCommand:()=>D,invokeFunction:()=>k,listCommands:()=>E,reloadPlugs:()=>F});function k(e,t,...r){return n(\"system.invokeFunction\",e,t,...r)}function D(e){return n(\"system.invokeCommand\",e)}function E(){return n(\"system.listCommands\")}function F(){n(\"system.reloadPlugs\")}var o=self.syscall;var q=u(l(\"https://esm.sh/handlebars\"));var j=u(l(\"https://deno.land/std/encoding/yaml.ts\"));var x=u(l(\"https://deno.land/std/encoding/yaml.ts\"));function P(){return console.log(\"POSTing on call\"),a.invokeFunction(\"server\",\"postOnCall\")}var W=P;return T(B);})();\n return mod;})()"
    },
    "postOnCall": {
      "env": "server",
      "cron": "0 8 * * 1",
      "code": "(() => { var mod=(()=>{var Q=Object.create;var h=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var X=Object.getPrototypeOf,Z=Object.prototype.hasOwnProperty;var k=(e=>typeof require!=\"undefined\"?require:typeof Proxy!=\"undefined\"?new Proxy(e,{get:(t,r)=>(typeof require!=\"undefined\"?require:t)[r]}):e)(function(e){if(typeof require!=\"undefined\")return require.apply(this,arguments);throw new Error('Dynamic require of \"'+e+'\" is not supported')});var w=(e,t)=>{for(var r in t)h(e,r,{get:t[r],enumerable:!0})},I=(e,t,r,n)=>{if(t&&typeof t==\"object\"||typeof t==\"function\")for(let o of J(t))!Z.call(e,o)&&o!==r&&h(e,o,{get:()=>t[o],enumerable:!(n=H(t,o))||n.enumerable});return e};var D=(e,t,r)=>(r=e!=null?Q(X(e)):{},I(t||!e||!e.__esModule?h(r,\"default\",{value:e,enumerable:!0}):r,e)),ee=e=>I(h({},\"__esModule\",{value:!0}),e);var Fe={};w(Fe,{default:()=>Ee});typeof self>\"u\"&&(self={syscall:()=>{throw new Error(\"Not implemented here\")}});var s=self.syscall;var b={};w(b,{parseMarkdown:()=>oe});function oe(e){return s(\"markdown.parseMarkdown\",e)}var m={};w(m,{deleteAttachment:()=>xe,deletePage:()=>ce,getAttachmentMeta:()=>de,getPageMeta:()=>ae,listAttachments:()=>me,listPages:()=>ie,listPlugs:()=>pe,readAttachment:()=>fe,readPage:()=>le,writeAttachment:()=>ge,writePage:()=>ue});function ie(e=!1){return s(\"space.listPages\",e)}function ae(e){return s(\"space.getPageMeta\",e)}function le(e){return s(\"space.readPage\",e)}function ue(e,t){return s(\"space.writePage\",e,t)}function ce(e){return s(\"space.deletePage\",e)}function pe(){return s(\"space.listPlugs\")}function me(){return s(\"space.listAttachments\")}function de(e){return s(\"space.getAttachmentMeta\",e)}function fe(e){return s(\"space.readAttachment\",e)}function ge(e,t,r){return s(\"space.writeAttachment\",e,t,r)}function xe(e){return s(\"space.deleteAttachment\",e)}var x={};w(x,{readAsset:()=>Pe});function G(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let o=0;o<r;o++)n[o]=t.charCodeAt(o);return n}var p=self.syscall;async function Pe(e,t=\"utf8\"){let r=await p(\"asset.readAsset\",e);switch(t){case\"utf8\":return new TextDecoder().decode(G(r.split(\",\")[1]));case\"dataurl\":return r}}var L=D(k(\"https://esm.sh/handlebars\"));var W=D(k(\"https://deno.land/std/encoding/yaml.ts\"));function E(e,t){if(t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...E(n,t)];return r}function F(e,t){return E(e,r=>r.type===t)[0]}function R(e,t){E(e,t)}var O=D(k(\"https://deno.land/std/encoding/yaml.ts\"));async function v(e,t=[\"yaml\"]){let r=await m.readPage(e),n=await b.parseMarkdown(r),o={};return R(n,a=>{if(a.type!==\"FencedCode\")return!1;let i=F(a,\"CodeInfo\");if(!i||!t.includes(i.children[0].text))return!1;let l=F(a,\"CodeText\");if(!l)return!1;let g=l.children[0].text;try{o=O.parse(g)}catch(c){throw console.error(\"YAML Page parser error\",c),new Error(`YAML Error: ${c.message}`)}return!0}),o}async function T(e){try{let t=await v(\"SECRETS\",[\"yaml\",\"secrets\"]),r=[];for(let n of e){let o=t[n];if(o)r.push(o);else throw new Error(`No such secret: ${n}`)}return r}catch(t){throw t.message===\"Page not found\"?new Error(`No such secret: ${e[0]}`):t}}var j=\"https://community.mattermost.com\",q=\"https://mattermost.app.opsgenie.com/webapi/webcal/getRecentSchedule\",M=\"jwz9juqg7tyetb97ykrw53n91a\",P=\"ak1ac7bhujgqzypnbijcq6m9tw\",U=\"opsgenie/user-mappings\";async function Me(e,t){let r=W.stringify(t);await m.writePage(e,\"```yaml\\n\"+r+\"\\n```\")}var d;async function Se(){d||(d=await v(U))}async function Ae(){await Me(U,d)}async function f(e,t,r){let[n]=await T([\"setMattermostToken\"]),o=`${j}${e}`,a={Authorization:`Bearer ${n}`,\"Content-Type\":\"application/json\"},i=await fetch(o,{method:t,headers:a,body:r?JSON.stringify(r):void 0});if(i.status<200&&i.status>=300)throw new Error(`${i.status} ${await i.text()}`);return await i.json()}async function S(e){if(await Se(),d[e])return d[e];let t=(await f(`/api/v4/users/autocomplete?name=${encodeURIComponent(e)}`,\"GET\")).users;if(t.length===0)throw new Error(`No matching user found: ${e}`);t.length>1&&console.warn(\"Multiple users found\",t.map(n=>n.username));let r={id:t[0].id,username:t[0].username};return d[e]=r,await Ae(),r}function B(e){return f(\"/api/v4/posts\",\"POST\",{channel_id:P,message:e})}function _(e,t){return f(`/api/v4/channels/${e}/patch`,\"PUT\",{id:e,...t})}async function K(e){console.log(\"Assigning new userIds\",e);let t=await f(`/api/v4/users?in_group=${M}&per_page=50`,\"GET\");await f(`/api/v4/groups/${M}/members`,\"DELETE\",{user_ids:t.map(r=>r.id)}),console.log(\"Cleared @set\"),await f(`/api/v4/groups/${M}/members`,\"POST\",{user_ids:e}),console.log(\"Set up new @set members\")}function Ce(e){return new Date(`${e.substring(0,4)}-${e.substring(4,6)}-${e.substring(6,8)}`)}async function N(e){let[t]=await T([\"setOpsGenieTokens\"]),o=(await(await fetch(`${q}?${t[e]}`)).text()).split(`\n`),a,i,l=[];for(let u=0;u<o.length;u++){let y=o[u];if(y.startsWith(\"DTSTART;\"))a=Ce(y.split(\":\")[1].split(\"T\")[0]);else if(y.startsWith(\"SUMMARY:\")){let z=y.substring(8).split(\"(\")[0].trim();l.push({name:z,date:a})}}let g=[],c=l[0].name,A=l[0].date,C=l[0].date;for(let u of l)u.name!==c&&(g.push({name:c,start:A,end:C}),A=u.date,c=u.name),C=u.date;return g.push({name:c,start:A,end:C}),g}async function ke(e=new Date){let[t,r,n]=await Promise.all([N(\"lead\"),N(\"primary\"),N(\"backup\")]),a={date:new Date(e.setDate(e.getDate()-e.getDay()+1)).toISOString().split(\"T\")[0],lead:await S($(t,e)[0].name),primary:[],backup:[]};for(let{name:i}of $(r,e))a.primary.push(await S(i));for(let{name:i}of $(n,e))a.backup.push(await S(i));return a}async function V(){let e=await x.readAsset(\"templates/message-template.txt\");try{let t=L.default.compile(e,{noEscape:!0}),r=await ke(new Date),n=t(r);await B(n),await K([r.lead.id,...r.primary.map(o=>o.id),...r.backup.map(o=>o.id)]),await De(r)}catch(t){throw console.error(\"Error\",t),t}}async function De(e){let t=await x.readAsset(\"templates/header.txt\"),n=L.default.compile(t,{noEscape:!0})(e);console.log(\"Updating channel header\",P,n),console.log(\"Response\",await _(P,{header:n}))}function $(e,t){let r=[];for(let n of e)n.start<=t&&t<=n.end&&r.push(n);return r}var Ee=V;return ee(Fe);})();\n return mod;})()"
    }
  }
}